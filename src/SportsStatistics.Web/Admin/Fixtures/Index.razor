@page "/admin/fixtures"
@using SportsStatistics.Application.Seasons.GetAll
@using SportsStatistics.Web.Admin.Seasons

<PageTitle>Fixtures</PageTitle>

<FluentCard>

    <FluentSelect TOption="SeasonDto"
                  Label="Season"
                  Items="Seasons"
                  OptionText="@(s => s.Name)"
                  @bind-SelectedOption="SelectedSeason" />

    @if (@SelectedSeason is not null)
    {
        <FluentButton Appearance="Appearance.Accent" OnClick="ShowFixtureForm">
            Add Fixture
        </FluentButton>

        @if (IsFixtureFormVisible)
        {
            <FixtureForm OnCancel="@HideFixtureForm" OnSubmit="@OnSubmitAsync" SelectedCompetitionId="@SelectedSeason.Id" />
        }
    }

</FluentCard>

@code {
    private enum FixtureFormMode
    {
        Hide,
        Show,
    }

    private FixtureFormMode FormMode { get; set; } = FixtureFormMode.Hide;

    private IEnumerable<SeasonDto>? Seasons { get; set; }

    private SeasonDto? SelectedSeason { get; set; }

    private bool IsFixtureFormVisible => FormMode == FixtureFormMode.Show;

    protected override async Task OnInitializedAsync()
    {
        await LoadSeasonsAsync();
    }

    private void HideFixtureForm()
    {
        FormMode = FixtureFormMode.Hide;
    }

    private void ShowFixtureForm()
    {
        FormMode = FixtureFormMode.Show;
    }

    private async Task LoadSeasonsAsync()
    {
        var request = new GetSeasonsQuery();
        var result = await Messenger.SendAsync(request);
        if (result.IsFailure)
        {
            ToastService.ShowError("Unable to load seasons");
        }

        Seasons = result.Value.Select(x => new SeasonDto(x.Id, x.StartDate, x.EndDate, x.Name));

        var now = DateOnly.FromDateTime(DateTime.Now);
        SelectedSeason = Seasons.FirstOrDefault(x => x.StartDate <= now && now <= x.EndDate);
    }

    private async Task OnSubmitAsync(FixtureFormModel fixture)
    {
        await Task.CompletedTask;
    }
}
