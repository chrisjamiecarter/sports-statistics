@page "/players"
@using SportsStatistics.Application.Players.Commands.CreatePlayer

<PageTitle>Players / Team Management</PageTitle>

<FluentCard>
    
    <FluentLabel Typo="Typography.Header">
        Players / Team Management
    </FluentLabel>

    @if (PlayerFormVisible)
    {
        <PlayerForm Player="@SelectedPlayer" OnCancel="HidePlayerForm" OnClose="HidePlayerForm"  OnSubmit="HandleSubmitAsync" />
    }
    else
    {
        <FluentButton Appearance="Appearance.Accent" OnClick="(() => ShowPlayerForm())">
            Add Player
        </FluentButton>

        <PlayerList Players="@Players" OnDeletePlayer="@Test" OnEditPlayer="@HandleEditPlayer" />
    }

</FluentCard>

@code {
    // TODO: decide route:
    // players or team-management.
    // admin/players or admin/team-management.

    private IQueryable<PlayerDto>? Players { get; set; }

    private bool PlayerFormVisible { get; set; }

    private PlayerDto? SelectedPlayer { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadPlayersAsync();
    }

    public async Task Test(PlayerDto player)
    {
        await Task.CompletedTask;
    }

    private void HidePlayerForm()
    {
        PlayerFormVisible = false;
        SelectedPlayer = null;
    }

    private async Task LoadPlayersAsync()
    {
        var request = new GetPlayersQuery();
        var result = await Sender.SendAsync(request);

        Players = result.Select(player => new PlayerDto(player.Id, player.Name, player.Role, player.SquadNumber, player.Nationalty, player.Age)).AsQueryable();
    }

    private void ShowPlayerForm(PlayerDto? player = null)
    {
        SelectedPlayer = player;
        PlayerFormVisible = true;
    }

    private void HandleEditPlayer(PlayerDto player)
    {
        ShowPlayerForm(player);
    }

    private async Task HandleSubmitAsync(PlayerInputModel player)
    {
        if (SelectedPlayer is null)
        {
            var command = new CreatePlayerCommand(player.Name, player.Role, player.SquadNumber, player.Nationality, DateOnly.FromDateTime(player.DateOfBirth.GetValueOrDefault()));
            var result = await Sender.SendAsync(command);

            if (result.IsSuccess)
            {
                ToastService.ShowSuccess("Player created successfully.");
            }
            else
            {
                ToastService.ShowError(result.Error.Message);
            }
        }

        await LoadPlayersAsync();
        HidePlayerForm();
    }
}
