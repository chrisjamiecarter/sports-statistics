@page "/match-tracker"
@using SportsStatistics.Application.Abstractions.Messaging
@using SportsStatistics.Application.Fixtures.GetByDate
@using SportsStatistics.Application.MatchTracking.GetByFixtureId
@using SportsStatistics.Application.MatchTracking.MatchEvents.Create
@using SportsStatistics.Application.MatchTracking.PlayerEvents.Create
@using SportsStatistics.Application.MatchTracking.SubstitutionEvents.Create
@using SportsStatistics.Application.MatchTracking.SubstitutionEvents.GetByFixtureId
@using SportsStatistics.Application.Players.GetAll
@using SportsStatistics.Application.Teamsheets.Create
@using SportsStatistics.Application.Teamsheets.GetByFixtureId
@using SportsStatistics.Domain.MatchTracking
@using SportsStatistics.Domain.MatchTracking.MatchEvents
@using SportsStatistics.Web.Abstractions.Messaging
@using SportsStatistics.Web.MatchTracker
@implements IDisposable

<PageTitle>Match Tracker</PageTitle>

<FluentCard Style="overflow-y: auto;">

    <FluentBreadcrumb Style="margin-bottom: 1rem;">
        <FluentBreadcrumbItem Appearance="Appearance.Accent">
            Match Tracker
        </FluentBreadcrumbItem>
    </FluentBreadcrumb>

    @switch (CurrentPageState)
    {
        case PageState.FixtureSelect:
            <FixtureSelector TodaysFixture="@Fixture" OnFixtureSelected="FixtureSelected" />
            break;
        case PageState.TeamsheetSelect:
            @if (ExistingTeamsheet is null)
            {
                <TeamsheetSelector Players="@Players" OnTeamsheetConfirmed="TeamsheetConfirmed" OnCancelled="TeamsheetCancelled" />
            }
            else
            {
                <FluentStack Orientation="Orientation.Vertical">
                    <FluentLabel Typo="Typography.Subject" Weight="FontWeight.Bold">
                        Teamsheet Already Submitted
                    </FluentLabel>
                    <FluentLabel Typo="Typography.Body">
                        Submitted at: @ExistingTeamsheet.SubmittedAtUtc.ToLocalTime().ToString("g")
                    </FluentLabel>
                    <FluentButton Appearance="Appearance.Accent" OnClick="ProceedToMatchTracking">
                        Continue to Match Tracking
                    </FluentButton>
                </FluentStack>
            }
            break;
        case PageState.MatchTracking:
            <FluentStack Orientation="Orientation.Vertical">
                <MatchHeader Fixture="@Fixture" GameClock="@gameClock" CurrentMatchPeriod="@currentPeriod" />
                <MatchEvents CurrentMatchPeriod="@currentPeriod" 
                             OnStartFirstHalf="StartMatch"
                             OnFinishFirstHalf="FinishFirstHalf"
                             OnStartSecondHalf="StartSecondHalf"
                             OnFinishSecondHalf="FinishSecondHalf"
                             OnHomeGoal="HomeGoal" 
                             OnAwayGoal="AwayGoal" />
                <MatchTracker Players="@StartingPlayers"
                              SubstitutePlayers="@AvailableSubstitutes"
                              PlayersSubstitutedOff="@_substitutedOffPlayerIds"
                              PlayersSubstitutedOn="@_substitutedOnPlayerIds"
                              PlayerStatuses="@_playerStatuses"
                              CurrentHalf="@currentPeriod.Value"
                              FixtureId="@Fixture!.Id"
                              CurrentMinute="@currentMinute"
                              MatchInProgress="@(currentPeriod.IsPlayingPeriod())"
                              OnAddPlayerEvent="AddPlayerEvent"
                              OnAddSubstitutionEvent="AddSubstitutionEvent" />
                <Overview MatchEvents="@DisplayEvents" />
            </FluentStack>
            break;
        default:
            break;
    }

</FluentCard>

@code {
    private enum PageState
    {
        FixtureSelect = 0,
        TeamsheetSelect = 1,
        MatchTracking = 2,
    }

    public FixtureDto? Fixture { get; set; }

    public List<MatchEventResponse> PersistedEvents { get; set; } = [];

    public List<DisplayMatchEventDto> DisplayEvents { get; set; } = [];

    public List<PlayerDto>? Players { get; set; }

    public List<PlayerDto> StartingPlayers { get; set; } = [];

    public List<PlayerDto> SubstitutePlayers { get; set; } = [];

    private HashSet<Guid> _substitutedOffPlayerIds = [];
    private HashSet<Guid> _substitutedOnPlayerIds = [];
    private Dictionary<Guid, PlayerStatusDto> _playerStatuses = new();

    private List<PlayerDto> AvailableSubstitutes =>
        SubstitutePlayers.Where(p => !_substitutedOnPlayerIds.Contains(p.Id)).ToList();

    public TeamsheetResponse? ExistingTeamsheet { get; set; }

    private PageState CurrentPageState = PageState.FixtureSelect;

    private MatchPeriod currentPeriod = MatchPeriod.PreMatch;
    private int currentMinute => (int)gameClock.TotalMinutes + 1;
    private System.Timers.Timer? _timer;
    private DateTime? matchStartedAtUtc;
    private TimeSpan gameClock
    {
        get
        {
            if (!matchStartedAtUtc.HasValue)
                return TimeSpan.Zero;

            var elapsedThisPeriod = DateTime.UtcNow - matchStartedAtUtc.Value;

            if (currentPeriod == MatchPeriod.FirstHalf)
            {
                return elapsedThisPeriod;
            }

            if (currentPeriod == MatchPeriod.SecondHalf)
            {
                return TimeSpan.FromMinutes(45) + elapsedThisPeriod;
            }

            return TimeSpan.Zero;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadFixtureAsync(DateOnly.FromDateTime(DateTime.UtcNow));
        await LoadPlayersAsync();
    }

    private async Task LoadFixtureAsync(DateOnly fixtureDate)
    {
        var request = new GetFixturesByDateQuery(fixtureDate);
        var result = await Messenger.SendAsync(request);
        if (result.IsFailure)
        {
            Fixture = null;
            ToastService.ShowError(result.Error.Description);
            return;
        }

        Fixture = result.Value.FirstOrDefault()?.ToDto();
    }

    private async Task LoadPlayersAsync()
    {
        var request = new GetAllPlayersQuery();
        var result = await Messenger.SendAsync(request);
        if (result.IsFailure)
        {
            Players = [];
            ToastService.ShowError(result.Error.Description);
            return;
        }

        Players = result.Value.Select(player => player.ToDto()).ToList();
    }

    private async Task LoadMatchEventsAsync()
    {
        if (Fixture is null) return;

        var request = new GetMatchEventsByFixtureIdQuery(Fixture.Id);
        var result = await Messenger.SendAsync(request);
        if (result.IsFailure)
        {
            PersistedEvents = [];
            return;
        }

        PersistedEvents = result.Value;
        UpdateDisplayEvents();
        UpdatePlayerStatuses();
    }

    private async Task LoadExistingTeamsheetAsync()
    {
        if (Fixture is null || Players is null) return;

        var request = new GetTeamsheetByFixtureIdQuery(Fixture.Id);
        var result = await Messenger.SendAsync(request);
        if (result.IsFailure)
        {
            ExistingTeamsheet = null;
            return;
        }

        ExistingTeamsheet = result.Value;

        if (ExistingTeamsheet is not null)
        {
            var playerDict = Players.ToDictionary(p => p.Id);

            StartingPlayers = ExistingTeamsheet.Starters
                .Where(s => playerDict.ContainsKey(s.PlayerId))
                .Select(s => playerDict[s.PlayerId])
                .ToList();

            SubstitutePlayers = ExistingTeamsheet.Substitutes
                .Where(s => playerDict.ContainsKey(s.PlayerId))
                .Select(s => playerDict[s.PlayerId])
                .ToList();
        }
    }

    private async Task LoadSubstitutionsAsync()
    {
        if (Fixture is null) return;

        var query = new GetSubstitutionsByFixtureIdQuery(Fixture.Id);
        var result = await Messenger.SendAsync(query);

        if (result.IsFailure)
        {
            _substitutedOffPlayerIds = [];
            _substitutedOnPlayerIds = [];
            return;
        }

        _substitutedOffPlayerIds = result.Value.Select(s => s.PlayerOffId).ToHashSet();
        _substitutedOnPlayerIds = result.Value.Select(s => s.PlayerOnId).ToHashSet();

        foreach (var playerOnId in _substitutedOnPlayerIds)
        {
            var playerOn = SubstitutePlayers.FirstOrDefault(p => p.Id == playerOnId);
            if (playerOn is not null && !StartingPlayers.Contains(playerOn))
            {
                StartingPlayers.Add(playerOn);
            }
        }
    }

    private void UpdateDisplayEvents()
    {
        DisplayEvents = PersistedEvents
            .Select(e => new DisplayMatchEventDto(e.DisplayMinute, e.EventType, e.PlayerName ?? "", e.OccurredAtUtc))
            .OrderBy(e => e.OccurredAtUtc)
            .ToList();
    }

    private void UpdatePlayerStatuses()
    {
        var statuses = new Dictionary<Guid, PlayerStatusDto>();
        var allPlayers = StartingPlayers.Concat(SubstitutePlayers).ToList();

        foreach (var player in allPlayers)
        {
            var playerEvents = PersistedEvents
                .Where(e => e.PlayerId == player.Id)
                .ToList();

            // Cards (yellow and red - only 1 of each max per business rule)
            var hasYellowCard = playerEvents.Any(e => e.EventType == "YellowCard");
            var hasRedCard = playerEvents.Any(e => e.EventType == "RedCard");

            // Goals
            var goals = playerEvents
                .Where(e => e.EventType == "Goal")
                .OrderByDescending(e => e.OccurredAtUtc)
                .Select(e => new GoalEventDto(e.OccurredAtUtc))
                .ToList();

            // Assists
            var assists = playerEvents
                .Where(e => e.EventType == "GoalAssist")
                .OrderByDescending(e => e.OccurredAtUtc)
                .Select(e => new AssistEventDto(e.OccurredAtUtc))
                .ToList();

            // Substitution
            SubstitutionStatusDto? substitution = null;
            if (_substitutedOffPlayerIds.Contains(player.Id))
            {
                substitution = new SubstitutionStatusDto(false, true, DateTime.UtcNow);
            }
            else if (_substitutedOnPlayerIds.Contains(player.Id))
            {
                substitution = new SubstitutionStatusDto(true, false, DateTime.UtcNow);
            }

            statuses[player.Id] = new PlayerStatusDto(
                player.Id,
                hasYellowCard,
                hasRedCard,
                goals,
                assists,
                substitution);
        }

        _playerStatuses = statuses;
    }

    private async Task FixtureSelected(Guid fixtureId)
    {
        await LoadExistingTeamsheetAsync();
        CurrentPageState++;
    }

    private async Task TeamsheetConfirmed(IReadOnlyList<PlayerDto> selectedPlayers)
    {
        if (Fixture is null || Players is null) return;

        var starterIds = selectedPlayers.Select(p => p.Id).ToList();

        var command = new CreateTeamsheetCommand(Fixture.Id, starterIds);
        var result = await Messenger.SendAsync(command);
        if (result.IsFailure)
        {
            ToastService.ShowError(result.Error.Description);
            return;
        }

        StartingPlayers = selectedPlayers.ToList();
        SubstitutePlayers = Players
            .Where(p => !starterIds.Contains(p.Id))
            .ToList();

        CurrentPageState++;
        await LoadSubstitutionsAsync();
        await LoadMatchEventsAsync();
    }

    private async Task ProceedToMatchTracking()
    {
        CurrentPageState++;
        await LoadSubstitutionsAsync();
        await LoadMatchEventsAsync();
    }

    private async Task TeamsheetCancelled()
    {
        CurrentPageState--;
        await Task.CompletedTask;
    }

    private async Task StartMatch()
    {
        matchStartedAtUtc = DateTime.UtcNow;
        currentPeriod = MatchPeriod.FirstHalf;
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += (_, _) => InvokeAsync(StateHasChanged);
        _timer.Start();

        // TODO: Magic numbers for regulation time start minutes - consider deriving from domain or configuration.
        await RecordMatchEvent(MatchEventType.FirstHalfStarted.Value, 1);
    }

    private async Task FinishFirstHalf()
    {
        var minuteResult = GetMinute();
        if (minuteResult.IsFailure)
        {
            // Default if we can't determine the minute - this is not ideal but allows the match to progress in case of issues with the game clock calculation.
            await RecordMatchEvent(MatchEventType.FirstHalfFinished.Value, currentMinute);
        }

        var minute = minuteResult.Value;
        currentPeriod = MatchPeriod.HalfTime;
        await RecordMatchEvent(MatchEventType.FirstHalfFinished.Value, minute.BaseMinute, minute.StoppageMinute);
    }

    private Result<Minute> GetMinute()
    {
        int minute = 0;
        int? stoppageMinute = null;

        var period = currentPeriod;
        if (period == MatchPeriod.FirstHalf)
        {
            if (currentMinute > 45)
            {
                minute = 45;
                stoppageMinute = currentMinute - 45;
            }
            else
            {
                minute = currentMinute;
            }
        }

        if (period == MatchPeriod.SecondHalf)
        {
            if (currentMinute > 90)
            {
                minute = 90;
                stoppageMinute = currentMinute - 90;
            }
            else
            {
                minute = currentMinute;
            }
        }

        return Minute.Create(minute, stoppageMinute);
    }

    private async Task StartSecondHalf()
    {
        matchStartedAtUtc = DateTime.UtcNow;
        currentPeriod = MatchPeriod.SecondHalf;

        // TODO: Magic numbers for regulation time start minutes - consider deriving from domain or configuration.
        await RecordMatchEvent(MatchEventType.SecondHalfStarted.Value, 46);
    }

    private async Task FinishSecondHalf()
    {
        var minuteResult = GetMinute();
        if (minuteResult.IsFailure)
        {
            // Default if we can't determine the minute - this is not ideal but allows the match to progress in case of issues with the game clock calculation.
            await RecordMatchEvent(MatchEventType.FirstHalfFinished.Value, currentMinute);
        }

        var minute = minuteResult.Value;
        currentPeriod = MatchPeriod.FullTime;

        await RecordMatchEvent(MatchEventType.SecondHalfFinished.Value, minute.BaseMinute, minute.StoppageMinute);
    }

    private async Task HomeGoal()
    {
        if (Fixture is null) return;

        Fixture = Fixture with { HomeGoals = Fixture.HomeGoals + 1 };
        
        var minuteResult = GetMinute();
        if (minuteResult.IsFailure)
        {
            // Default if we can't determine the minute - this is not ideal but allows the match to progress in case of issues with the game clock calculation.
            await RecordMatchEvent(MatchEventType.HomeGoal.Value, currentMinute);
        }
        
        var minute = minuteResult.Value;
        await RecordMatchEvent(MatchEventType.HomeGoal.Value, minute.BaseMinute, minute.StoppageMinute);
    }

    private async Task AwayGoal()
    {
        if (Fixture is null) return;

        Fixture = Fixture with { AwayGoals = Fixture.AwayGoals + 1 };
        
        var minuteResult = GetMinute();
        if (minuteResult.IsFailure)
        {
            // Default if we can't determine the minute - this is not ideal but allows the match to progress in case of issues with the game clock calculation.
            await RecordMatchEvent(MatchEventType.AwayGoal.Value, currentMinute);
        }

        var minute = minuteResult.Value;
        await RecordMatchEvent(MatchEventType.AwayGoal.Value, minute.BaseMinute, minute.StoppageMinute);
    }

    private async Task RecordMatchEvent(int eventTypeId, int baseMinute, int? stoppageMinute = null)
    {
        if (Fixture is null) return;

        var command = new CreateMatchEventCommand(
            Fixture.Id,
            eventTypeId,
            baseMinute,
            stoppageMinute,
            DateTime.UtcNow);

        var result = await Messenger.SendAsync(command);
        if (result.IsFailure)
        {
            ToastService.ShowError(result.Error.Description);
            return;
        }

        await LoadMatchEventsAsync();
    }

    private async Task AddPlayerEvent(PlayerEventDto playerEvent)
    {
        var command = new CreatePlayerEventCommand(
            playerEvent.FixtureId,
            playerEvent.PlayerId,
            playerEvent.PlayerEventTypeId,
            playerEvent.BaseMinute,
            playerEvent.StoppageMinute,
            playerEvent.OccurredAtUtc);

        var result = await Messenger.SendAsync(command);
        if (result.IsFailure)
        {
            ToastService.ShowError(result.Error.Description);
            return;
        }

        await LoadMatchEventsAsync();
    }

    private async Task AddSubstitutionEvent(SubstitutionEventDto substitutionEvent)
    {
        var command = new CreateSubstitutionEventCommand(
            substitutionEvent.FixtureId,
            substitutionEvent.PlayerOffId,
            substitutionEvent.PlayerOnId,
            substitutionEvent.BaseMinute,
            substitutionEvent.StoppageMinute,
            substitutionEvent.OccurredAtUtc);

        var result = await Messenger.SendAsync(command);
        if (result.IsFailure)
        {
            ToastService.ShowError(result.Error.Description);
            return;
        }

        _substitutedOffPlayerIds.Add(substitutionEvent.PlayerOffId);
        _substitutedOnPlayerIds.Add(substitutionEvent.PlayerOnId);

        var playerOn = SubstitutePlayers.FirstOrDefault(p => p.Id == substitutionEvent.PlayerOnId);
        if (playerOn is not null && !StartingPlayers.Contains(playerOn))
        {
            StartingPlayers.Add(playerOn);
        }

        await LoadMatchEventsAsync();
    }

    public void Dispose()
    {
        _timer?.Stop();
        _timer?.Dispose();
    }
}
