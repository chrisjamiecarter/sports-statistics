@page "/match-tracker"
@using SportsStatistics.Application.Abstractions.Messaging
@using SportsStatistics.Application.Fixtures.GetByDate
@using SportsStatistics.Application.Players.GetAll
@using SportsStatistics.Web.Abstractions.Messaging
@implements IDisposable

<PageTitle>Match Tracker</PageTitle>

<FluentCard Style="overflow-y: auto;">

    <FluentBreadcrumb Style="margin-bottom: 1rem;">
        <FluentBreadcrumbItem Appearance="Appearance.Accent">
            Match Tracker
        </FluentBreadcrumbItem>
    </FluentBreadcrumb>

    @switch (CurrentPageState)
    {
        case PageState.FixtureSelect:
            <FixtureSelector TodaysFixture="@Fixture" OnFixtureSelected="FixtureSelected" />
            break;
        case PageState.TeamsheetSelect:
            <TeamsheetSelector Players="@Players" OnTeamsheetConfirmed="TeamsheetConfirmed" OnCancelled="TeamsheetCancelled" />
            break;
        case PageState.MatchTracking:
        <FluentStack Orientation="Orientation.Vertical">
            <MatchHeader Fixture="@Fixture" GameClock="@gameClock" MatchStarted="@matchStarted"/>
            <MatchEvents CurrentHalf="@currentHalf" OnStartFirstHalf="StartMatch" OnHomeGoal="HomeGoal" OnAwayGoal="AwayGoal" />
            <MatchTracker Players="@SelectedPlayers" OnAddMatchEvent="AddMatchEvent" />
            <Overview MatchEvents="@MatchEvents" />
        </FluentStack>
            break;
        default:
            break;
    }

</FluentCard>

@code {
    private enum PageState
    {
        FixtureSelect = 0,
        TeamsheetSelect = 1,
        MatchTracking = 2,
    }

    public FixtureDto? Fixture { get; set; }

    public List<MatchEventDto> MatchEvents { get; set; } = [];

    public List<PlayerDto>? Players { get; set; }

    public List<PlayerDto> SelectedPlayers { get; set; } = [];

    private PageState CurrentPageState = PageState.FixtureSelect;

    protected override async Task OnInitializedAsync()
    {
        await LoadFixtureAsync(DateOnly.FromDateTime(DateTime.UtcNow));
        await LoadPlayersAsync();
    }

    private async Task LoadFixtureAsync(DateOnly fixtureDate)
    {
        var request = new GetFixturesByDateQuery(fixtureDate);
        var result = await Messenger.SendAsync(request);
        if (result.IsFailure)
        {
            Fixture = null;
            ToastService.ShowError(result.Error.Description);
            return;
        }

        Fixture = result.Value.FirstOrDefault()?.ToDto();
    }

    private async Task LoadPlayersAsync()
    {
        var request = new GetAllPlayersQuery();
        var result = await Messenger.SendAsync(request);
        if (result.IsFailure)
        {
            Players = [];
            ToastService.ShowError(result.Error.Description);
            return;
        }

        Players = result.Value.Select(player => player.ToDto()).ToList();
    }

    private async Task FixtureSelected(Guid fixtureId)
    {
        Console.WriteLine($"Selected Fixture ID: {fixtureId}");
        CurrentPageState++;
        await Task.CompletedTask;
    }

    private async Task TeamsheetConfirmed(IReadOnlyList<PlayerDto> players)
    {
        Console.WriteLine($"Selected Players: {string.Join(',', players.Select(player => player.Name))}");
        SelectedPlayers = players.ToList();
        CurrentPageState++;
        await Task.CompletedTask;
    }

    private async Task TeamsheetCancelled()
    {
        Console.WriteLine("Teamsheet Cancelled");
        CurrentPageState--;
        await Task.CompletedTask;
    }

    private async Task AddMatchEvent(MatchEventDto matchEvent)
    {
        MatchEvents.Add(matchEvent);
        await Task.CompletedTask;
    }

    // TODO:
    private int currentHalf = 0;
    private System.Timers.Timer? _timer;
    private DateTime? matchStartedAtUtc;
    private TimeSpan gameClock => matchStartedAtUtc.HasValue ? DateTime.UtcNow - matchStartedAtUtc.Value : TimeSpan.Zero;
    private bool matchStarted = false;
    private async Task StartMatch()
    {
        matchStartedAtUtc = DateTime.UtcNow;
        matchStarted = true;
        currentHalf = 1;
        _timer = new System.Timers.Timer(1000);
        _timer.Elapsed += (_, _) => InvokeAsync(StateHasChanged);
        _timer.Start();

        await AddMatchEvent(new MatchEventDto("First Half Started", matchStartedAtUtc.Value));
    }

    private async Task HomeGoal()
    {
        Fixture = Fixture! with { HomeGoals = Fixture.HomeGoals + 1 };
        await AddMatchEvent(new MatchEventDto("Home Goal", DateTime.UtcNow));
    }

    private async Task AwayGoal()
    {
        Fixture = Fixture! with { AwayGoals = Fixture.AwayGoals + 1 };
        await AddMatchEvent(new MatchEventDto("Away Goal", DateTime.UtcNow));
    }

    public void Dispose()
    {
        _timer?.Stop();
        _timer?.Dispose();
    }
}
